# Windows 11 Utility VM Master Guide

**Introduction**

This guide is designed to create a lightweight, utility-focused Windows 11 Virtual Machine using Virt-Manager. It specifically targets **Bazzite** (Fedora Atomic), utilizing `rpm-ostree` for system layering, but the core KVM/QEMU concepts apply to most modern Linux distributions with minor package management adjustments.

**Human note:** Yes, this markdown document was, aside from this note, generated by Google Gemini. I've done step-by-step testing and tweaking to work out any issues I could find. 

**Key Features:**
*   **Local Account:** Enforced via network bypass to avoid Microsoft Account requirements.
*   **Performance:** Uses VirtIO drivers and file sharing (virtiofs) for native-speed access to host files.
*   **Privacy:** Aggressive debloating and telemetry reduction.

*Disclaimer: No guarantees are provided. These instructions have been tested as of December 2nd, 2025, on Bazzite 43.*

---

**I. Host Preparation (Bazzite)**

**A. Install Virtualization Packages**

1. Open your terminal.
2. Run the following commands to layer the components. If a package is reported as "Already provided," simply proceed to the next line.
   ```bash
   rpm-ostree install qemu-kvm     # Core KVM virtualization engine
   rpm-ostree install libvirt      # Virtualization management daemon
   rpm-ostree install edk2-ovmf    # UEFI Firmware (Required for Win11)
   rpm-ostree install swtpm        # TPM Emulator (Required for Win11)
   rpm-ostree install swtpm-tools  # TPM Setup Scripts (Prevents setup errors)
   rpm-ostree install virt-manager # GUI Management Tool
   ```

**B. Apply Changes**

1. Reboot your system to finalize the layered packages.

**C. Enable Services & Fix TPM Permissions**

1. Enable the virtualization daemon:
   ```bash
   sudo systemctl enable --now libvirtd
   sudo usermod -aG libvirt $(whoami)
   ```
2. **Verify TPM Support Directory:**
   The TPM emulator requires a specific directory to store certificates. Check if it exists and has the correct permissions:
   ```bash
   ls -ld /var/lib/swtpm-localca
   ```
3. **If the directory does not exist** (or you get an error), run these commands to fix it:
   ```bash
   sudo mkdir -p /var/lib/swtpm-localca
   sudo chown tss:tss /var/lib/swtpm-localca
   sudo chmod 750 /var/lib/swtpm-localca
   ```

**II. Storage & Resource Setup**

**A. Create Directory Structure**

1. Create the directory for VM files:
   ```bash
   mkdir -p /var/home/$(whoami)/VMs/downloads
   ```

**B. Download ISOs**

1. **Windows 11 ISO:**
   *   Go to the [Microsoft Windows 11 Download Page](https://www.microsoft.com/software-download/windows11).
   *   Scroll to **Download Windows 11 Disk Image (ISO) for x64 devices**.
   *   Select **Windows 11 (multi-edition ISO)**, choose your language, and Download.
   *   **Save to:** `/var/home/$(whoami)/VMs/downloads/`
   *   *User Note:* Your filename will vary (e.g., `Win11_24H2_English_x64.iso`). Use your actual filename in the commands below.
2. **Verify Windows ISO:**
   *   Run this command and ensure the output matches the hash on the Microsoft website:
       ```bash
       sha256sum ~/VMs/downloads/Win11_[version].iso
       ```
3. **VirtIO Drivers:**
   *   Download the latest "Stable" release (`virtio-win.iso`) from the [Fedora VirtIO repository](https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso).
   *   **Save to:** `/var/home/$(whoami)/VMs/downloads/`

**C. Create Optimized Disk Image**

1. Create the disk manually to enable performance flags hidden by the GUI:
   ```bash
   qemu-img create -f qcow2 -o lazy_refcounts=on,extended_l2=on,cluster_size=64k /var/home/$(whoami)/VMs/win11-utility.qcow2 128G
   ```

**D. Targeted Permissions**

1. We grant `qemu` (the VM user) access **only** to the specific files we just created.
   ```bash
   # Allow QEMU to search the directory path (needed to reach the files)
   sudo setfacl -m u:qemu:x /var/home/$(whoami)/VMs
   sudo setfacl -m u:qemu:x /var/home/$(whoami)/VMs/downloads

   # Allow QEMU to read/write the Disk Image
   sudo setfacl -m u:qemu:rw /var/home/$(whoami)/VMs/win11-utility.qcow2

   # Allow QEMU to read the ISOs
   sudo setfacl -m u:qemu:r /var/home/$(whoami)/VMs/downloads/*.iso
   ```

**III. VM Configuration (Virt-Manager GUI)**

**A. Initial Wizard**

1. Open **Virtual Machine Manager**.
2. Click **New VM** (Top-left).
3. **Step 1:** Select **Import existing disk image**. Click Forward.
4. **Step 2:**
   * Click **Browse...** -> **Browse Local**.
   * Select `win11-utility.qcow2` from your `~/VMs` folder.
   * **OS Type:** Search/Select "Microsoft Windows 11". Click Forward.
5. **Step 3 (Resources):**
   * **Memory:** 8192 (8GB).
   * **CPUs:** 2.
   * Click Forward.
6. **Step 4 (Finalize):**
   * **Name:** `Win11-Utility`.
   * **Important:** Check **Customize configuration before install**.
   * Click **Finish**.

**B. Deep Configuration (The "Customize" Window)**

*Perform these steps before clicking "Begin Installation".*
*Note: As you move between sections, click **Apply** when prompted.*

1. **Firmware (UEFI)**
   * On the **Overview** tab, find **Firmware**.
   * Select the option containing `UEFI` and `OVMF_CODE.secboot.fd`.
   * Click **Apply**.

2. **TPM (Windows 11 Requirement)**
   * Look for a **TPM** entry on the left.
   * *User Note:* If no TPM exists, click **Add Hardware** -> **TPM** to create one.
   * Select the **TPM** entry.
   * **Type:** Emulated device.
   * **Model:** Click **Advanced options** (drop-down) and select **CRB** (Command Response Buffer).
   * **Version:** 2.0.
   * Click **Apply**.

3. **Memory Optimization (Ballooning)**
   * Select **Memory**.
   * Check **Enable shared memory**.
   * **Maximum allocation:** 8192 MB.
   * **Current allocation:** 4096 MB.
   * Click **Apply**.

4. **CPU Configuration**
   * Select **CPUs**.
   * Expand **Configuration**.
   * Uncheck "Copy host CPU configuration" (if checked), then re-check it to ensure **Host passthrough** is active.
   * Click **Apply**.

5. **Storage Optimization**
   * Select **SATA Disk 1** (your qcow2 file).
   * Change **Disk bus** to `VirtIO`.
   * Click **Apply**.

6. **Add ISOs (CDROMs)**
   * Click **Add Hardware** -> **Storage**.
   * **Device type:** CDROM device.
   * **Manage:** Browse to `~/VMs/downloads` and select your **Windows 11 ISO**.
   * Click **Finish**.
   * Click **Add Hardware** -> **Storage** (again).
   * **Device type:** CDROM device.
   * **Manage:** Browse to `~/VMs/downloads` and select your **VirtIO Drivers ISO**.
   * Click **Finish**.

7. **Network Strategy (Force Offline)**
   * Select the **NIC** entry (e.g., `NIC :xx:xx:xx`).
   * Uncheck the **Active** box.
   * Click **Apply**.

8. **Shared Files (VirtIO-FS)**
   * Click **Add Hardware** -> **Filesystem**.
   * **Driver:** virtiofs.
   * **Source Path:** Browse/Select `/home/bazzite`. (Click **Yes** if permission popup appears).
   * **Target Path:** `host_share`.
   * Click **Finish**.
   * *Note:* `host_share` is the "tag" you will use inside Windows to map this drive.
   * Click **Apply**.

9. **Start Install**
   * Click **Begin Installation** (Top Left).

**IV. Installation & Drivers**

**A. Boot Process**

1. **Click inside the black window immediately** and press a key when prompted to "Boot from CD/DVD".
2. Wait for the initial Windows Setup screen (Language/Time selection).

**B. The Requirements Bypass (Registry)**

*User Note: Even though we added a TPM 2.0 module, virtualization quirks often cause the installer to fail the requirements check. We will perform a standard registry bypass now to guarantee the installation proceeds without error.*

1. At the very first screen (Language/Time), press **Shift + F10** on your keyboard.
2. In the Command Prompt window that opens, type `regedit` and press **Enter**.
3. Navigate to: `HKEY_LOCAL_MACHINE` -> `SYSTEM` -> `Setup`.
4. Right-click the `Setup` folder -> **New** -> **Key**.
   *   Name it: `LabConfig`
5. Right-click the new `LabConfig` folder -> **New** -> **DWORD (32-bit) Value**.
   *   Name it: `BypassTPMCheck`
   *   Double-click it and set Value data to: `1`
6. Right-click `LabConfig` again -> **New** -> **DWORD (32-bit) Value**.
   *   Name it: `BypassSecureBootCheck`
   *   Double-click it and set Value data to: `1`
7. Close the Registry Editor and the Command Prompt.

**C. Initial Setup**

1. Select your Language and Time format and press **Next**.
2. Select Keyboard and press **Next**.
3. Check "I would like to: Install Windows 11" and check the agreement that all files will be deleted. Press **Next**.
4. On "Product Key" click **I don't have a product key**.
5. On "Select Image" click **Windows 11 Pro** (or your preferred version) and press **Next**.
   *   *Note: Because of the registry keys in step B, this should proceed immediately.*
6. Select **Custom: Install Windows only (advanced)**.

**D. Load Storage Drivers**

1. On the screen "Select location to install Windows 11", the list will be empty.
2. Click **Load Driver** -> **Browse**.
3. Navigate to: `CD Drive (virtio-win)` -> `amd64` -> `w11` and click **OK**.
4. Select **Red Hat VirtIO SCSI controller** and click **Next**.
5. The drive will appear as "Unallocated Space". Select it.
6. Click **Install** to begin the installation.
7. **Coffee Break:** Allow Windows to run the install. It will copy files and automatically reboot.

**E. OOBE Network Bypass & Account**

1. When the system returns from reboot, it will ask for your **Country/Region**.
2. **Stop here.** Press **Shift + F10**.
3. In the Command Prompt, type the following command and press **Enter**:
   ```cmd
   OOBE\BYPASSNRO
   ```
4. The VM will reboot immediately.
5. Once rebooted, confirm Region and press **Yes**.
6. Confirm Keyboard layout and press **Yes** (Skip second keyboard).
7. You will arrive at "Let's connect you to a network." Click **I don't have internet**.
8. Click **Continue with limited setup**.
9. **Create your Local Account:**
   *   **Username:** Enter your choice.
   *   **Password:** Leave blank (for auto-login) or pick one you will remember.
10. **Privacy Settings:**
    *   Toggle **ALL** settings (Location, Find My Device, Diagnostic Data, etc.) to **No**.
    *   *Why:* These send telemetry to Microsoft. They are unnecessary for this utility VM.

**V. Drivers & Network Enablement**

**A. Install All VirtIO Drivers & Guest Utils**

1. On the Windows Desktop, open File Explorer.
2. Go to the VirtIO ISO drive.
3. Run `virtio-win-gt-x64.exe` and accept all defaults.
4. Run `virtio-win-guest-tools.exe` and accept all defaults.

**B. Enable Network & Remove ISOs**

1. **Shut down** the VM.
2. Open VM Details (Lightbulb) in Virt-Manager.
3. **Remove ISOs:**
   *   Select **SATA CDROM 1**. Click **Remove**.
   *   Select **SATA CDROM 2**. Click **Remove**.
   *   *Note:* This cleans up "This PC" and prevents boot loops.
4. **Enable Network:**
   *   Select the **NIC**.
   *   Check **Active**.
   *   **Device model:** Change to `virtio`.
   *   **Network source:** Select **Virtual network 'default': NAT**.
   *   *User Note:* **NAT** is the safe option for tools running on the host. If you need this VM to have its own IP address accessible by other computers on your home WiFi/LAN, select **Bridge device** instead.
   *   Click **Apply**.
5. Boot the VM.

**C. Install WinFSP (Required for Shared Folders)**

*User Note: The driver for shared folders (VirtIO-FS) relies on a library called WinFSP. The Guest Tools installer often fails to install this correctly. We will do it manually now that the network is active.*

1. Open Edge/Browser inside the VM.
2. Go to [winfsp.dev](https://winfsp.dev) and download the latest **Installer (MSI)**.
3. Run the installer (accept defaults).
4. **Configure the Service:**
   *   Press `Win + R`, type `services.msc`, and press Enter.
   *   Locate **VirtIO-FS Service**.
   *   Double-click it.
   *   Change **Startup type** to **Automatic**.
   *   Click **Start**.

**VI. Optimization & Debloat**

*Intro: Since we used a Local Account, services like OneDrive are dormant. This phase helps reclaim space and stop background telemetry.*

**A. Rename PC**

1. Go to Settings -> System -> About.
2. Click **Rename this PC**.
3. Enter a name (e.g., `VM-Win11-Utility` or your choice).
4. Click **Next**, but select **Restart Later** so we can finish the remaining steps first.

**B. Power & Sleep Settings**

1. Go to Settings -> System -> Power & battery.
2. **Power Mode:** Set to **Best Performance**.
3. Expand **Screen and sleep**:
   *   **When plugged in, turn off my screen after:** Set to **10 minutes** (or your preference).
   *   **Sleep:** If the option exists, set to **Never**. (Note: Virtual Machines often hide this setting because they don't support sleep states. This is fine).

**C. Disable Widgets (Weather)**

1. Right-click the Taskbar and select **Taskbar settings**.
2. Toggle **Widgets** to **Off**.

**D. Limit Pagefile**

1. Go to Settings -> System -> About -> Advanced system settings.
2. Performance Settings -> Advanced Tab -> Virtual Memory "Change".
3. Uncheck "Automatically manage".
4. **Custom size**: 1024 MB (Initial) - 2048 MB (Max).
5. Click Set -> OK.
   *   *User Note:* Optional. Prevents indefinite swap file growth.

**E. Disable Hibernation**

1. Click Start, type **PowerShell**.
2. Right-click **Windows PowerShell** (the blue icon, not "Terminal") and select **Run as Administrator**.
3. Run:
   ```powershell
   powercfg /h off
   ```
4. **Keep this PowerShell window open** for the next step.

**F. Chris Titus Debloat (Tweaks)**

*User Note: This tool applies various system tweaks. The configuration below effectively breaks the modern "Windows Terminal" app but leaves standard PowerShell working. If you intend to install other tools later, you can reopen this utility at any time.*

1. In the open Administrator PowerShell, run:
   ```powershell
   iwr -useb https://christitus.com/win | iex
   ```
2. Click the **Tweaks** tab at the top.
3. Select the **Standard** Profile.
4. **Add these specific Checkboxes:**
   *   **Disable Hibernation** (Just to be sure).
   *   **Edge Debloat** (*User Note: Edge remains installed but fewer annoyances*).
   *   **Disable Recall** (*User Note: Ensures AI screenshot feature is dead*).
   *   **Disable Microsoft Copilot** (*User Note: Unless you plan to use it*).
   *   **Remove OneDrive** (*User Note: Unless you plan to use it*).
5. **Set these Toggles (Right side):**
   *   **Dark Theme:** On (*User Note: Your choice*).
   *   **Recommendations in Start Menu:** **Disable** (Turn toggle On).
   *   **Bing Search in Start Menu:** Off.
   *   **Sticky Keys:** Off.
   *   **Show Hidden Files:** On.
   *   **Show File Extensions:** On.
   *   **Cross-Device Resume:** Off.
6. Click **Run Tweaks**.
7. Wait for it to finish (Status: Done).
8. **Reboot** the VM.

**G. Chris Titus Debloat (O&O ShutUp10)**

1. Once rebooted, open **Windows PowerShell** (Admin) again.
2. Run the tool again:
   ```powershell
   iwr -useb https://christitus.com/win | iex
   ```
3. Click **Run OO Shutup 10**.
4. You can accept the recommended defaults or tailor them to your liking.
5. Close the tools and perform a **Final Reboot**.

**VII. Usage (Accessing Game Data)**

**A. Map the Drive**

1. Open File Explorer. Look for a network drive (Z:).
2. If missing, run in PowerShell:
   ```powershell
   net use Z: \\sshfs\host_share /PERSISTENT:YES
   ```
---

**Human note:** At this point your VM is nice and tidy and ready for installing whatever things you absolutely needed to run on Windows. I'm honestly surprised it took me 9 months of dedicated Bazzite usage before I had to break down and install a Windows VM. 

Examples:

* AMUMSS for No Man's Sky (tried Bottles, way too complicated in the batch files, not worth the time)
* Device firmware updaters (mice, keyboards, headsets, etc). However this VM is NOT configured to passthrough any devices. I'll work up a new page for that when I get it working. Note that for things like mouse/keyboard you're going to want a second device that you can use for input while passing through the one you'll be updating. 


